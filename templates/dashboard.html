<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBD-II Real-Time Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4ade80;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-start {
            background: #4ade80;
            color: white;
        }

        .btn-start:hover {
            background: #22c55e;
        }

        .btn-stop {
            background: #f87171;
            color: white;
        }

        .btn-stop:hover {
            background: #ef4444;
        }

        .btn-export {
            background: #60a5fa;
            color: white;
        }

        .btn-export:hover {
            background: #3b82f6;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .metric-unit {
            font-size: 16px;
            color: #999;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
        }

        canvas {
            max-height: 300px;
        }

        .message {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .message.error {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .message.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó OBD-II Real-Time Dashboard</h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionStatus">Disconnected</span>
                </div>
                <div class="controls">
                    <button class="btn-start" onclick="startMonitoring()">‚ñ∂ Start</button>
                    <button class="btn-stop" onclick="stopMonitoring()">‚èπ Stop</button>
                    <button class="btn-export" onclick="exportData()">üìä Export CSV</button>
                </div>
            </div>
            <div id="messages"></div>
        </header>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Engine RPM</div>
                <div class="metric-value" id="rpm">--</div>
                <div class="metric-unit">rpm</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Speed</div>
                <div class="metric-value" id="speed">--</div>
                <div class="metric-unit">km/h</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Engine Load</div>
                <div class="metric-value" id="engineLoad">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Coolant Temperature</div>
                <div class="metric-value" id="coolantTemp">--</div>
                <div class="metric-unit">¬∞C</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Throttle Position</div>
                <div class="metric-value" id="throttlePos">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Intake Pressure</div>
                <div class="metric-value" id="intakePressure">--</div>
                <div class="metric-unit">kPa</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">RPM & Speed History</div>
                <canvas id="rpmSpeedChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Engine Load & Throttle</div>
                <canvas id="loadThrottleChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Temperature Readings</div>
                <canvas id="tempChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Air Flow & Pressure</div>
                <canvas id="airflowChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();

        // Data storage for charts
        const maxDataPoints = 50;
        const timeLabels = [];
        const rpmData = [];
        const speedData = [];
        const loadData = [];
        const throttleData = [];
        const coolantTempData = [];
        const intakeTempData = [];
        const mafData = [];
        const intakePressureData = [];

        // Chart.js configurations
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
                duration: 0
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        };

        // Initialize charts
        const rpmSpeedChart = new Chart(document.getElementById('rpmSpeedChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'RPM',
                        data: rpmData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Speed (km/h)',
                        data: speedData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'RPM' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Speed (km/h)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        const loadThrottleChart = new Chart(document.getElementById('loadThrottleChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Engine Load (%)',
                        data: loadData,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)'
                    },
                    {
                        label: 'Throttle Position (%)',
                        data: throttleData,
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)'
                    }
                ]
            },
            options: chartOptions
        });

        const tempChart = new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Coolant Temp (¬∞C)',
                        data: coolantTempData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)'
                    },
                    {
                        label: 'Intake Temp (¬∞C)',
                        data: intakeTempData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)'
                    }
                ]
            },
            options: chartOptions
        });

        const airflowChart = new Chart(document.getElementById('airflowChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'MAF (g/s)',
                        data: mafData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Intake Pressure (kPa)',
                        data: intakePressureData,
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.1)',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'MAF (g/s)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Pressure (kPa)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // Socket event handlers
        socket.on('connect', () => {
            updateConnectionStatus(true);
            showMessage('Connected to server', 'success');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            showMessage('Disconnected from server', 'error');
        });

        socket.on('obd_data', (data) => {
            updateMetrics(data);
            updateCharts(data);
        });

        socket.on('status', (data) => {
            showMessage(data.message, data.error ? 'error' : 'success');
        });

        // Update functions
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                dot.classList.add('connected');
                status.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                status.textContent = 'Disconnected';
            }
        }

        function updateMetrics(data) {
            document.getElementById('rpm').textContent = data.RPM ? Math.round(data.RPM) : '--';
            document.getElementById('speed').textContent = data.SPEED ? Math.round(data.SPEED) : '--';
            document.getElementById('engineLoad').textContent = data.ENGINE_LOAD ? data.ENGINE_LOAD.toFixed(1) : '--';
            document.getElementById('coolantTemp').textContent = data.COOLANT_TEMP ? Math.round(data.COOLANT_TEMP) : '--';
            document.getElementById('throttlePos').textContent = data.THROTTLE_POS ? data.THROTTLE_POS.toFixed(1) : '--';
            document.getElementById('intakePressure').textContent = data.INTAKE_PRESSURE ? data.INTAKE_PRESSURE.toFixed(1) : '--';
        }

        function updateCharts(data) {
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            // Add new data
            timeLabels.push(timestamp);
            rpmData.push(data.RPM || null);
            speedData.push(data.SPEED || null);
            loadData.push(data.ENGINE_LOAD || null);
            throttleData.push(data.THROTTLE_POS || null);
            coolantTempData.push(data.COOLANT_TEMP || null);
            intakeTempData.push(data.INTAKE_TEMP || null);
            mafData.push(data.MAF || null);
            intakePressureData.push(data.INTAKE_PRESSURE || null);
            
            // Remove old data
            if (timeLabels.length > maxDataPoints) {
                timeLabels.shift();
                rpmData.shift();
                speedData.shift();
                loadData.shift();
                throttleData.shift();
                coolantTempData.shift();
                intakeTempData.shift();
                mafData.shift();
                intakePressureData.shift();
            }
            
            // Update charts
            rpmSpeedChart.update();
            loadThrottleChart.update();
            tempChart.update();
            airflowChart.update();
        }

        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            messagesDiv.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        // Control functions
        function startMonitoring() {
            socket.emit('start_monitoring');
            showMessage('Starting OBD monitoring...', 'info');
        }

        function stopMonitoring() {
            socket.emit('stop_monitoring');
            showMessage('Stopping OBD monitoring...', 'info');
        }

        function exportData() {
            window.location.href = '/api/export_csv';
            showMessage('Exporting data...', 'success');
        }

        // Auto-start monitoring on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                startMonitoring();
            }, 1000);
        });
    </script>
</body>
</html>
